# Delayed Notifier Service

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (Email, Telegram) —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫.

## üöÄ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (Senior Highlights)

–ü—Ä–æ–µ–∫—Ç —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ —Å —É–ø–æ—Ä–æ–º –Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (Reliability) –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:

*   **Transactional Outbox Pattern:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. API —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–¥–∞—á—É –≤ PostgreSQL, –∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (Scheduler) –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –µ—ë –≤ –æ—á–µ—Ä–µ–¥—å. –≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ—è—Ö –±—Ä–æ–∫–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π.
*   **High-Availability Scheduler:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –∑–∞–¥–∞—á —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `FOR UPDATE SKIP LOCKED`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å: –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ–¥–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
*   **Self-Healing & Recovery:** –í–Ω–µ–¥—Ä–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º **Visibility Timeout**. –ï—Å–ª–∏ –≤–æ—Ä–∫–µ—Ä –≤–∑—è–ª –∑–∞–¥–∞—á—É –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É, –Ω–æ —É–ø–∞–ª (OOM, —Å–µ—Ç–µ–≤–æ–π —Å–±–æ–π), –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç ¬´–∑–∞–≤–∏—Å—à—É—é¬ª –∑–∞–¥–∞—á—É –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ –∏ –≤–µ—Ä–Ω–µ—Ç –µ—ë –≤ –æ—á–µ—Ä–µ–¥—å.
*   **Asynchronous Exponential Backoff:** –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, API –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ) —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á.
*   **Strategy Pattern (Open-Closed Principle):** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ–Ω–¥–µ—Ä–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (SMS, Push, Slack) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤–æ—Ä–∫–µ—Ä–∞.
*   **Graceful Shutdown:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞—Ç—á, –∞ –≤–æ—Ä–∫–µ—Ä—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ RabbitMQ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º.

## üõ† –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

- **Language:** Go 1.25+
- **Message Broker:** RabbitMQ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Delayed Message Plugin)
- **Database:** PostgreSQL (—á–∏—Å—Ç—ã–π SQL, —Å–ª–æ–∂–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
- **Caching:** Redis (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤)
- **Framework:** Gin (—Å –∫–∞—Å—Ç–æ–º–Ω–æ–π –æ–±–µ—Ä—Ç–∫–æ–π ginext)
- **Logging:** Zerolog (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∑–∞–¥–∞—á–∏)

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º **Clean Architecture**:

1.  **Domain:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π (Notify), —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤/–æ—á–µ—Ä–µ–¥–µ–π.
2.  **Usecase:** –õ–æ–≥–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (Scheduler) –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
3.  **Worker:** –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å (Consumer) –æ—á–µ—Ä–µ–¥–∏, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –ª–æ–≥–∏–∫—É —Ä–µ—Ç—Ä–∞–µ–≤.
4.  **Adapters:** 
    *   **Postgres:** –°–ª–æ–∂–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –±–∞–∑–µ –ë–î.
    *   **RabbitMQ:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±—Ä–æ–∫–µ—Ä–æ–º —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `wbf`.
    *   **Sender:** –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è Email –∏ Telegram Bot API.

## üìä –õ–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (Recovery SQL)

–ö–ª—é—á–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
```sql
WITH selected AS (
    SELECT notify_id FROM notify
    WHERE (status = $1 AND scheduled_at <= NOW()) -- –ù–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
       OR (status = $2 AND updated_at <= NOW() - make_interval(secs => $5)) -- "–ó–æ–º–±–∏"-–∑–∞–¥–∞—á–∏
    ORDER BY scheduled_at ASC
    LIMIT $3
    FOR UPDATE SKIP LOCKED -- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
)
UPDATE notify SET status = $4, updated_at = NOW() FROM selected ...
```
## üõ† API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

|–ú–µ—Ç–æ–¥	|–ü—É—Ç—å	|–û–ø–∏—Å–∞–Ω–∏–µ|
|-------|-----|--------|
|`POST`	|`/notify`|	–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.|
|`GET`	|`/notify`|	–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π).|
|`GET`	|`/notify/:id`|	–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.|
|`DELETE`	|`/notify/:id`|	–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.|

## üö¶ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
1. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:

```bash
docker-compose up -d
```

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ config/config.yaml (—É–∫–∞–∂–∏—Ç–µ DSN –±–∞–∑—ã –∏ —Ç–æ–∫–µ–Ω Telegram).
3. **–ó–∞–ø—É—Å–∫**:

```bash
go run cmd/main.go
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π Web UI (–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É —Å–µ—Ä–≤–µ—Ä–∞), –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫**: [Aliev Abakar]

**–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞**: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—è–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.


